version: '3.8'
services:
  # ----------------------------------------------------
  # SERVICIO 1: MINECRAFT SERVER (Estable)
  # ----------------------------------------------------
  minecraft_server:
    build: 
      context: . 
      dockerfile: dockerfile 
      args: 
        SERVER_ENV: ${SERVER_ENV:-prod} 
        CACHE_BUST: ${BUILD_ID:-11} # <<-- ¡CAMBIA ESTE NÚMERO! (e.g., a 11)
    container_name: ${CONTAINER_NAME:-mc-server}
    restart: unless-stopped
    command: /usr/local/bin/entrypoint.sh 
    deploy:
      resources:
        limits: { cpus: '2.0', memory: 4096m }
        reservations: { cpus: '0.5', memory: 1G }
    volumes:
      - minecraft_data:/data 
    environment:
      JAVA_OPTS: "-Xmx${MINECRAFT_MEMORY_LIMIT:-3G} -Xms1G" 
      EULA: "TRUE"
      JAVA_OPTS_GC: "-XX:+AlwaysPreTouch -XX:+DisableExplicitGC -XX:+ParallelRefProcEnabled -XX:+PerfDisableSharedMem -XX:+UnlockExperimentalVMOptions -XX:+UseG1GC -XX:G1HeapRegionSize=8M -XX:G1HeapWastePercent=5 -XX:G1MaxNewSizePercent=40 -XX:G1MixedGCCountTarget=4 -XX:G1NewSizePercent=30 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:G1ReservePercent=20 -XX:InitiatingHeapOccupancyPercent=15 -XX:MaxGCPauseMillis=200 -XX:MaxTenuringThreshold=1 -XX:SurvivorRatio=32"
    expose: [ "25565" ]
    networks:
      - default 
      - minecraft_tunnel_network 
      
# ----------------------------------------------------
  # SERVICIO 2: PLAYIT.GG TUNNEL (CONFIGURACIÓN ESTABLE)
  # ----------------------------------------------------
  playit_agent:
    # CRÍTICO: Usamos la imagen oficial de GitHub Container Registry (GHCR.IO).
    # Esto resuelve tu error de "no such file or directory" y otros fallos de build.
    image: ghcr.io/playit-cloud/playit-agent:latest 
    container_name: playit_minecraft_tunnel
    restart: unless-stopped
    
    # <<<<<< ELIMINA TODA LA SECCIÓN 'build:' si existe >>>>>>
    # build:
    #   context: .
    #   dockerfile: playit.dockerfile 
    
    # CRÍTICO: Sobrescribimos el comando para forzar el modo interactivo.
    # Esto debería evitar el error MalformedSecret si el volumen está vacío.
    command: ["/usr/bin/playit"] 

    # Esenciales para obtener el código de reclamo en los logs
    stdin_open: true
    tty: true

    # DNS fix como buena práctica para estabilidad de red
    dns:
      - 8.8.8.8
      - 1.1.1.1

    networks:
      - minecraft_tunnel_network
      
    # CRÍTICO: Volumen para persistir la configuración.
    # La ruta para esta imagen oficial es /etc/playit
    volumes:
      - playit_config_data:/etc/playit

      
# ----------------------------------------------------\
# DEFINICIÓN DE VOLÚMENES Y REDES 
# ----------------------------------------------------\
volumes:
  minecraft_data:
    name: ${WORLD_VOLUME_NAME:-mc-world-data}
    driver: local
  # Nuevo volumen para persistir la configuración de playit
  playit_config_data:
    name: ${PLAYIT_CONFIG_VOLUME_NAME:-playit-config}
    driver: local

networks:
  default:
    driver: bridge
  minecraft_tunnel_network:
    driver: bridge
    internal: true
