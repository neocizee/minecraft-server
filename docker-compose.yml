version: '3.8'
services:
  minecraft_server:
    # Build la imagen
    build: 
      context: . 
      args: 
        SERVER_ENV: ${SERVER_ENV} # Pasa la variable de entorno (prod/staging) al Dockerfile
        
    container_name: ${CONTAINER_NAME} # Nombre único por entorno
    restart: unless-stopped

    command: java $JAVA_OPTS -jar paper.jar nogui

    # Límites de recursos (BUENA PRÁCTICA)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4096m
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Persistencia de Datos: CRÍTICO
    volumes:
      # Mapea el volumen nombrado al WORKDIR del contenedor
      - minecraft_data:/server 
    
    # Variables de Entorno (JAVA_OPTS es la variable de RAM usada en el Dockerfile)
    environment:
      JAVA_OPTS: "-Xmx${MINECRAFT_MEMORY_LIMIT} -Xms1G" # Usa la variable de Portainer para el límite
      EULA: "TRUE"
          
    expose:
      - "25565"

    # Conectar a la red de Cloudflare Tunnel (Usaremos esto más adelante)
    networks:
      - default 
      - minecraft_tunnel_network # Nuevo nombre de red
  
# Definición de Volúmenes y Redes
volumes:
  minecraft_data: 
    name: ${WORLD_VOLUME_NAME}
    driver: local

# Redes (Este stack crea la red si no existe)
networks:
  default:
    driver: bridge
  minecraft_tunnel_network: # La red que ahora crea este stack
    name: minecraft_tunnel_network 
    driver: bridge
