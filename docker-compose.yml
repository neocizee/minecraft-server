version: '3.8'
services:
  minecraft_server:
    # Build la imagen
    build: 
      context: . # Usa la carpeta actual como contexto
      # CRÍTICO: Pasar la variable SERVER_ENV al Dockerfile
      args: 
        SERVER_ENV: ${SERVER_ENV} 
        
    container_name: ${CONTAINER_NAME} # Definido por variable (ej: mc_prod)
    restart: unless-stopped

    # Límites de recursos (Aplicados por Docker/Portainer)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4096m
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Persistencia de Datos: CRÍTICO para el mundo.
    volumes:
      # Monta el volumen de mundo específico para la rama
      - ${WORLD_VOLUME_NAME}:/server 
      
    # Variables de Entorno - Usaremos variables para definir la RAM de Java
    environment:
      # RAM de Java (se usará como -Xmx/-Xms en el CMD de Portainer, no en el Dockerfile)
      # Esto permite cambiar la RAM sin reconstruir la imagen.
      JAVA_OPTS: "-Xmx${MINECRAFT_MEMORY_LIMIT} -Xms1G" 
      EULA: "TRUE"

    expose:
      - "25565"

    # Conectar a la red de Cloudflare Tunnel
    networks:
      - default 
      - cloudflare_tunnel_network 

# Volúmenes para persistir el mundo de Minecraft
volumes:
  # El nombre real del volumen se define por la variable ${WORLD_VOLUME_NAME}
  ${WORLD_VOLUME_NAME}:
    driver: local 

# Redes
networks:
  default:
    driver: bridge
  cloudflare_tunnel_network:
    external: true
    name: YOUR_CLOUDFLARE_TUNNEL_NETWORK_NAME