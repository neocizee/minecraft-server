version: '3.8'
services:
  minecraft_server:
    build: 
      context: . 
      args: 
        SERVER_ENV: ${SERVER_ENV}
        CACHE_BUST: ${BUILD_ID} # Cache Buster
        
    container_name: ${CONTAINER_NAME}
    restart: unless-stopped

    # El comando es el script de entrada (entrypoint.sh)
    command: /usr/local/bin/entrypoint.sh 

    # Límites de recursos (Se mantienen)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4096m
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Volumen: Mapea a /data donde entrypoint.sh copia/ejecuta los archivos
    volumes:
      - minecraft_data:/data 
    
    environment:
      JAVA_OPTS: "-Xmx${MINECRAFT_MEMORY_LIMIT} -Xms1G" # RAM
      EULA: "TRUE"
      BUILD_ID: "6" # <-- CAMBIA ESTE VALOR CADA VEZ QUE HAGAS UN BUILD
      JAVA_OPTS_GC: "-XX:+AlwaysPreTouch -XX:+DisableExplicitGC -XX:+ParallelRefProcEnabled -XX:+PerfDisableSharedMem -XX:+UnlockExperimentalVMOptions -XX:+UseG1GC -XX:G1HeapRegionSize=8M -XX:G1HeapWastePercent=5 -XX:G1MaxNewSizePercent=40 -XX:G1MixedGCCountTarget=4 -XX:G1NewSizePercent=30 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:G1ReservePercent=20 -XX:InitiatingHeapOccupancyPercent=15 -XX:MaxGCPauseMillis=200 -XX:MaxTenuringThreshold=1 -XX:SurvivorRatio=32"
          
    expose:
      - "25565" # Puerto interno de Minecraft

    networks:
      - default 
      - minecraft_tunnel_network 
      
  # ----------------------------------------------------
  # NUEVO SERVICIO: PLAYIT.GG TUNNEL
  # ----------------------------------------------------
  playit_agent:
      # 1. Imagen base ligera con Alpine y la versión de Java necesaria, o una imagen base
      #    que facilite la instalación (usaremos una imagen genérica para el build).
      image: playit-agent-build:latest
      container_name: playit_minecraft_tunnel
      restart: unless-stopped
      
      # 2. Build de una imagen personalizada para instalar playit.gg.
      # Necesitas un Dockerfile simple llamado 'playit.dockerfile'
      build:
        context: .
        dockerfile: playit.dockerfile
      
      # 3. CRÍTICO: El comando inicia el agente, exponiendo el puerto 25565
      #    del servicio 'minecraft_server' dentro de la red 'minecraft_tunnel_network'.
      #    La opción '-d' es para que corra en background, pero el entrypoint del dockerfile
      #    de playit debe manejar el 'run'. Aquí usamos 'playit' como comando de entrada.
      #    (El comando real de inicio se manejará en el Dockerfile/Entrypoint del agente para el claim)
      
      # 4. CRÍTICO: Conectamos a la red interna.
      networks:
        - minecraft_tunnel_network
        
      # 5. La configuración de playit.gg se guardará aquí.
      #    Reemplaza 'playit_config_data' con el nombre de tu volumen si ya usas uno.
      volumes:
        - playit_config_data:/root/.playit
      
      # 6. Mantenemos el STDIN abierto para poder ingresar el código de claim inicial
      #    (solo por única vez).
      stdin_open: true  # Mantener abierto el STDIN para el claim code
      tty: true
      
# Definición de Volúmenes (Se añaden los datos de Playit)
volumes:
  minecraft_data: 
    name: ${WORLD_VOLUME_NAME}
    driver: local
  playit_data: # Nuevo volumen para playit.toml
    name: playit_data
    driver: local

# Redes
networks:
  default:
    driver: bridge
  minecraft_tunnel_network: 
    name: minecraft_tunnel_network 
    driver: bridge
